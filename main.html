<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>PlateformerMarioLike</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>

<body>
    <script type="text/javascript">


        //Ecran d'acceuil

        class EcranAcceuil extends Phaser.Scene {
            constructor() {

                super("EcranAcceuil")
                this.cursors;
            }

            preload() {
                this.load.image('ecranAcceuil', 'ASSETS/tittleScreen.png')
            }

            create() {
                this.ecranAccueil = this.physics.add.staticGroup();
                this.ecranAccueil.create(400, 420, 'ecranAccueil')
                this.cursors = this.input.keyboard.createCursorKeys();
            }

            //Changement de scène
            update() {
                if (this.cursors.space.isDown) {
                    this.scene.start('Intro')
                }
            }
        }

        ////////////////////////////////////////NIVEAU 1////////////////////////////////////////
        class Intro extends Phaser.Scene {
            constructor() {
                super("Intro");
                this.player;
                this.Policier;
                this.Moto;
                this.Drone;
                this.cursors;
                this.gameOver = false;
                this.cameras;
                this.inventaire;
            }

            preload() {
                this.load.spritesheet('player', 'ASSETS/Hero.png',
                    { frameWidth: 50, frameHeight: 50 });
                this.load.image('Policier', 'ASSETS/policier.png',
                    { frameWidth: 40, frameHeight: 50 });
                this.load.image('Moto', 'ASSETS/moto police.png',
                    { frameWidth: 70, frameHeight: 70 });
                this.load.image('Drone', 'ASSETS/drone.png',
                    { frameWidth: 40, frameHeight: 50 });
                this.load.image('assetsIntro', 'ASSETS/tuileJeu2.png');
                this.load.tilemapTiledJSON('intro', 'ASSETS/map.json');
            }

            create() {

                //Tiled
                this.intro = this.add.tilemap('intro');
                this.tileset = this.intro.addTilesetImage(
                    "tuileJeu2",
                    "assetsIntro"
                );

                this.fond = this.intro.createLayer(
                    "fond",
                    this.tileset
                )

                this.obstacle = this.intro.createLayer(
                    "obstacle",
                    this.tileset
                )

                this.obstacle.setCollisionByProperty({ estSolide: true });

                //Colliders et autre
                this.player = this.physics.add.sprite(50, 1200, 'player');
                this.player.body.setSize(50,50,true)
                this.player.setOffset(8, 6);
                this.player.setCollideWorldBounds(true);
                this.physics.add.collider(this.player, this.obstacle);
                this.cursors = this.input.keyboard.createCursorKeys();

                this.anims.create({
                    key: 'walkRight',
                    frames: this.anims.generateFrameNumbers('player', { start: 0, end: 7 }),
                    frameRate: 10,
                    repeat: -1
                });
                this.anims.create({
                    key: 'walkLeft',
                    frames: this.anims.generateFrameNumbers('player', { start: 8, end: 15 }),
                    frameRate: 10,
                    repeat: -1
                });

                /// POICIER 1 ///
                this.Policier = this.physics.add.image(900, 1200, 'Policier');
                this.physics.add.collider(this.Policier, this.obstacle);
                this.physics.add.collider(this.Policier, this.player, this.death, null,this);
                this.Policier.setCollideWorldBounds(true);

                /// POLICIER 2 ///
                this.Policier2 = this.physics.add.image(1600, 1200, 'Policier');
                this.physics.add.collider(this.Policier2, this.obstacle);
                this.physics.add.collider(this.Policier2, this.player, this.death, null,this);
                this.Policier2.setCollideWorldBounds(true);

                /// POLICIER 3 ///
                this.Policier3 = this.physics.add.image(2159, 1200, 'Policier');
                this.physics.add.collider(this.Policier3, this.obstacle);
                this.physics.add.collider(this.Policier3, this.player, this.death, null,this);
                this.Policier3.setCollideWorldBounds(true);

                /// MOTO POLICE ///
                this.Moto = this.physics.add.image(3300, 1200, 'Moto');
                this.physics.add.collider(this.Moto, this.obstacle);
                this.physics.add.collider(this.Moto, this.player, this.death, null,this);
                this.Moto.setCollideWorldBounds(true);

                //Camera
                this.cameras.main.setBounds(0, 0, 4800, 1440);
                this.cameras.main.setSize(896, 614);
                this.cameras.main.startFollow(this.player);

                //Touches
                this.cursors = this.input.keyboard.createCursorKeys();
                this.keys = this.input.keyboard.addKeys({
                    z: Phaser.Input.Keyboard.KeyCodes.Z,
                });
            }

            update() {

                //Coordonnées
                console.log(this.player.x, this.player.y)

                //Déplacement et Changement de scène
                if (this.cursors.left.isDown) {
                    this.player.setVelocityX(-200);
                    this.player.anims.play('walkLeft', true);
                }
                else if (this.cursors.right.isDown) {
                    this.player.setVelocityX(200);
                    this.player.anims.play('walkRight', true);
                }
                if (Phaser.Input.Keyboard.JustDown(this.keys.z) && this.player.body.onFloor()) {
                    this.player.setVelocityY(-350);
                };

                //Changement de scène
                if (this.player.x >= 4750 && this.player.y <= 1400) {
                    this.scene.start('Intro');
                }

                /// DEPLACEMENT POLICIER 1 ///
                /// EN A PAS, EST FIXE ///

                /// DEPLACEMENT POLICIER 2 ///
                if (this.Policier2.x <= 1600){
                this.Policier2.setVelocityX(100)
                }

                if (this.Policier2.x >= 1980){
                this.Policier2.setVelocityX(-100)
                }

                /// DEPLACEMENT POLICIER 3 ///
                if (this.Policier3.x <= 2160){
                this.Policier3.setVelocityX(100)
                }

                if (this.Policier3.x >= 2350){
                this.Policier3.setVelocityX(-100)
                }

                /// DEPLACEMENT MOTO POLICE ///
                if (this.Moto.x <= 3310){
                this.Moto.setVelocityX(200)
                }

                if (this.Moto.x >= 3645){
                this.Moto.setVelocityX(-100)
                }
            }

            death() {
                this.dead = true;
                this.player.setVelocityY(0);
                this.player.setVelocityX(0);
                this.player.setTint(0xff0000);
                this.time.addEvent({
                    delay: 500,
                    callback: () => {
                        this.scene.start("Intro")
                    },
                    loop: false
                })
    }
        }

        var config = {
            pixelArt: true,
            type: Phaser.AUTO,
            width: 4800, height: 1440,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 500 },
                    debug: true
                }
            },
            input: { gamepad: true },
            scene: [EcranAcceuil, Intro]
        };
        new Phaser.Game(config);

    </script>